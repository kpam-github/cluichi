<!-- Lobby Full Screen -->
<div id="lobbyFull" style ="display:none">
	Error, game lobby is currently full. Please try again some other time.
</div>

<!-- Username Selection -->
<div id="signDiv">
	Please select a username: <input id="signDiv-username" type="text"></input><br>
	<button id="signDiv-signIn">Sign In</button>
</div>

<!-- Create or join a game -->
<div id="gameSelect" style="display:none">
	Please enter a game name: <input id="gameSelect-game" type="text"></input><br>
	Enter a password(optional): <input id="gameSelect-password" type = "text"></input><br>
	<button id="gameSelect-create">Create</button>
	<button id="gameSelect-join">Join</button>
	<br><div id="gameList"></div>
</div>

<!-- Game Screen -->
<div id="gameDiv" style="display:none;">
	<!-- Game Canvas -->
	<div id="game" style="position:absolute;" tabindex = "0">
		<canvas id="ctx" style="position:absolute;border:1px solid #000000;"></canvas>
	</div>
	
	<!-- Chat -->
	<div id="chat">	
		<hr/><div id = "chat-text-title" style= "text-align: center;"> Write Something Here
		<select name="chats" id = "chats" onchange = "displayChat()">
			<option value="game"> In-Game Chat</option>
			<option value="universal">Universal Chat</option>
		</select></div><hr />
		<div id="chat-text" style="overflow-y:scroll; display:none"></div>
		<div id="chat-group" style="overflow-y:scroll"></div>
		<form id="chat-form">
			<input id="chat-input" type="text"></input>
		</form>
	</div>
</div>

<!-- Socket.io -->
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

<script>
	
	var socket = io();
	
	// Disable context menu on mouse right click
	document.oncontextmenu = function(event){
		event.preventDefault();
	}
	
	// If lobby is full
	socket.on('lobbyFull', function(){
		document.getElementById('lobbyFull').style.display = "inline-block";
		document.getElementById('signDiv').style.display = "none";
	});
	
	//----------------------------------------
	// 			Set Width / Height
	// ---------------------------------------
	
	// Set WIDTH/HEIGHT
	// px value (e.g. '800') or percentage (e.g. '80%')
	var WIDTH = '90%';
	var HEIGHT = '500';
	
	setWidthHeight(WIDTH, HEIGHT);
	
	// Set elements to respond upon resizing of window if WIDTH / HEIGHT is a percentage
	if (isNaN(WIDTH) || isNaN(HEIGHT)){
		window.addEventListener('resize', function(){
			setWidthHeight(WIDTH, HEIGHT);
		});
	}
	
	function setWidthHeight(WIDTH, HEIGHT){
		//Convert Percentages if necessary
		if (isNaN(WIDTH))
			WIDTH = WIDTH.substring(0, WIDTH.indexOf("%")) * window.innerWidth / 100;
		if (isNaN(HEIGHT))
			HEIGHT = HEIGHT.substring(0, HEIGHT.indexOf("%")) * window.innerHeight /100;
			
		document.getElementById('ctx').style.width = WIDTH;
		document.getElementById('ctx').style.height = HEIGHT;
		document.getElementById('chat-text').style.width = WIDTH;
		document.getElementById('chat-group').style.width = WIDTH;
		document.getElementById('chat-input').style.width = WIDTH;
		document.getElementById('chat').style.marginTop = parseInt(HEIGHT) + 20;
		document.getElementById('chat-form').style.width= WIDTH;
		document.getElementById('chat-text').style.height = parseInt(HEIGHT)/5;
		document.getElementById('chat-group').style.height = parseInt(HEIGHT)/5;
		
	}
	
	//----------------------------------------
	// 				Username Selection
	// ---------------------------------------
	var gameSelect = document.getElementById('gameSelect');
	var signDiv = document.getElementById('signDiv');
	var signDivUsername = document.getElementById('signDiv-username');
	var signDivSignIn = document.getElementById('signDiv-signIn');
	
	signDivSignIn.onclick = function(){
		signDivUsername.value = signDivUsername.value.replace(/\s/g,'');
		signDivUsername.value = filterText(signDivUsername.value);
		if (signDivUsername.value.length > 2){
			socket.emit('signIn',signDivUsername.value);
		}
		else
			alert("Please enter a username with at 3 least characters");
	}
	
	socket.on('signInResponse',function(data){
		if(data.success){
			signDiv.style.display = 'none';
			gameSelect.style.display = 'inline-block';
			showPublicGames();
			setInterval(showPublicGames, 1000);
			//Automatically select text input area
			document.getElementById('gameSelect-game').focus();
			document.getElementById('gameSelect-game').select();
		} else
			alert("Username taken");
	});
	
	// Automatically Select Text Input Area
	signDivUsername.focus();
	signDivUsername.select();
	
	// Submit when enter is pressed
	signDiv.addEventListener("keydown", function(event) {
		if (event.keyCode == 13) {
			signDivSignIn.click();
		}
	});
	
	//----------------------------------------
	// 				Game Selection
	// ---------------------------------------
	var gameDiv = document.getElementById('gameDiv');
	var gameSelect = document.getElementById('gameSelect');
	var gameSelectGame = document.getElementById('gameSelect-game');
	var gameSelectCreate = document.getElementById('gameSelect-create');
	var gameSelectJoin = document.getElementById('gameSelect-join');
	var gameSelectPassword = document.getElementById('gameSelect-password');
	
	gameSelectCreate.onclick = function(){
		gameSelectGame.value = gameSelectGame.value.replace(/\s/g,'');
		gameSelectGame.value = filterText(gameSelectGame.value);
		gameSelectPassword.value = filterText(gameSelectPassword.value);
		if (gameSelectGame.value.length > 3){
			socket.emit('createGame',gameSelectGame.value, gameSelectPassword.value);
		}
		else
			alert("Please enter a game name with at 4 least characters");
	}
	
	showPublicGames = function() {
		socket.emit('gameSelection');
	}
	
	socket.on('publicGames', function (gameList){
		document.getElementById('gameList').innerHTML = "<div>" + gameList + "</div>";
	});
	
	socket.on('createGameResponse',function(data){
		if(data.success){
			gameSelect.style.display = 'none';
			gameDiv.style.display = 'inline-block';
			if (!data.chat)
				document.getElementById('chat').style.display = 'none';
			if(!data.universal)
				document.getElementById('chats').style.display = 'none';
			if(data.controls)
				trackControls();
			clearInterval(showPublicGames);
		} else
			alert("Game name taken");
	});	
	
	gameSelectJoin.onclick = function(){
		gameSelectGame.value = gameSelectGame.value.replace(/\s/g,'');
		if (gameSelectGame.value.length > 3){
			socket.emit('joinGame',gameSelectGame.value, gameSelectPassword.value);
		}
		else
			alert("Please enter a game name with at 4 least characters");
	}
	
	socket.on('joinGameResponse',function(data){
		if(data.success){
			gameSelect.style.display = 'none';
			gameDiv.style.display = 'inline-block';
			if (!data.chat)
				document.getElementById('chat').style.display = 'none';
			if(!data.universal)
				document.getElementById('chats').style.display = 'none';
			if(data.controls)
				trackControls();
			clearInterval(showPublicGames);
		} else {
			if (data.gameExist)
				alert("Incorrect password");
			else if (data.gameFull)
				alert("Game is full");
			else
				alert("Game doesn't exist");
		}
	});	
	
	//----------------------------------------
	// 				Chat
	// ---------------------------------------
	var chatDiv = document.getElementById('chat');
	var chatText = document.getElementById('chat-text');
	var chatInput = document.getElementById('chat-input');
	var chatForm = document.getElementById('chat-form');
	var groupChat = document.getElementById('chat-group');
	var chats = document.getElementById('chats');
	
	socket.on('addToChat',function(data){
		chatText.innerHTML += '<div>' + data + '</div>';
	});
	
	socket.on('addToGame', function(data){
		groupChat.innerHTML += '<div>' + data + '</div>';
	});
	
	displayChat = function(){
		if (chats.value==="universal"){
			chatText.style.display = 'inline-block';
			groupChat.style.display = 'none';
		}else {
			chatText.style.display = 'none';
			groupChat.style.display = 'inline-block';
		}
	}
		
	chatForm.onsubmit = function(e){
		e.preventDefault();
		chatInput.value = filterText(chatInput.value);
		if (chatInput.value.length > 0){
			if (chats.value==="universal")
				socket.emit('sendMsgToServer',chatInput.value);
			else
				socket.emit('sendMsgToGame', chatInput.value);
			chatInput.value = '';		
		}
	}
	
	//----------------------------------------
	// 				Controls
	// ---------------------------------------
	trackControls = function(){
		var gameCanvas = document.getElementById('game');
		gameCanvas.onkeydown = function(event){
			if(event.keyCode === 68 || event.keyCode === 39)	//d is 68, right is 39
				socket.emit('keyPress',{inputId:'right',state:true});
			else if(event.keyCode === 83 || event.keyCode === 40)	//s is 83, down is 40
				socket.emit('keyPress',{inputId:'down',state:true});
			else if(event.keyCode === 65 || event.keyCode === 37) //a is 65, left is 37
				socket.emit('keyPress',{inputId:'left',state:true});
			else if(event.keyCode === 87 || event.keyCode === 38) // w is 87, up is 38
				socket.emit('keyPress',{inputId:'up',state:true});		
		}
		
		gameCanvas.onkeyup = function(event){
			if(event.keyCode === 68 || event.keyCode === 39)	//d is 68, right is 39
				socket.emit('keyPress',{inputId:'right',state:false});
			else if(event.keyCode === 83 || event.keyCode === 40)	//s is 83, down is 40
				socket.emit('keyPress',{inputId:'down',state:false});
			else if(event.keyCode === 65 || event.keyCode === 37) //a is 65, left is 37
				socket.emit('keyPress',{inputId:'left',state:false});
			else if(event.keyCode === 87 || event.keyCode === 38) // w is 87, up is 38
				socket.emit('keyPress',{inputId:'up',state:false});
		}
	}
	
	//----------------------------------------
	//			Code Injection Security
	// ---------------------------------------
	
	filterText = function(text){
		// Remove everything except accepted characters
		text = text.replace(/[^ a-zA-Z0-9.,!?:;()áéíóú]/g, "");
		// Remove multiple spaces
		text = text.replace(/[ ]+/g, " ");
		return text;
	}
</script>