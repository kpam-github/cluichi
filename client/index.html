<body style = "padding-left: 5%; padding-top: 5%">

	<!-- Lobby Full Screen -->
	<div id="lobbyFull" style ="display:none">
		Error, game lobby is currently full. Please try again some other time.
	</div>

	<!-- Username Selection -->
	<div id="signDiv">
		Please select a username: <input id="signDiv-username" type="text"></input><br>
		<button id="signDiv-signIn">Sign In</button>
	</div>

	<!-- Create or join a game -->
	<div id="gameSelect" style="display:none">
		Please enter a game name: <input id="gameSelect-game" type="text"></input><br>
		Enter a password(optional): <input id="gameSelect-password" type = "text"></input><br>
		<button id="gameSelect-create">Create</button>
		<button id="gameSelect-join">Join</button>
		<br><div id="gameList"></div>
	</div>

	<!-- Game Screen -->
	<div id="gameDiv" style="display:none;">
		<!-- Game Canvas -->
		<div id="game" style="position:absolute;" tabindex = "0">
			<div id="ctx" style="position:absolute;border:1px solid #000000;"></div>
		</div>
		
		<!-- Chat -->
		<div id="chat">	
			<hr/><div id = "chat-text-title" style= "text-align: center;"> Write Something Here
			<select name="chats" id = "chats" onchange = "displayChat()">
				<option value="game"> In-Game Chat</option>
				<option value="universal">Universal Chat</option>
			</select></div><hr />
			<div id="chat-text" style="overflow-y:scroll; display:none"></div>
			<div id="chat-group" style="overflow-y:scroll"></div>
			<form id="chat-form" autocomplete="off">
				<input id="chat-input" type="text"></input>
			</form>
		</div>
	</div>

	<!-- Game Over Screen -->
	<div id = "endGame"></div>

</body>
<!-- Socket.io -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.js"></script>

<script>
	var socket = io();
	
	// Disable context menu on mouse right click
	document.oncontextmenu = function(event){
		event.preventDefault();
	}
	
	// If lobby is full
	socket.on('lobbyFull', function(){
		document.getElementById('lobbyFull').style.display = "inline-block";
		document.getElementById('signDiv').style.display = "none";
	});
	
	// If player disconnects during game, end game
	socket.on('endOfGame', function(str){
		var endGame = document.getElementById('endGame');
		endGame.innerHTML = "<h1>" + str + " has left, and so the game has ended...</h1>";
		endGame.style.display = "inline-block";
		document.getElementById('gameDiv').style.display = "none";
		socket.disconnect();
	});
	
	//----------------------------------------
	//			Cards Against Humanity Game
	// ---------------------------------------
	
	// Select canvas and add "row" class for Bootstrap
	var canvas = document.getElementById("ctx");
	canvas.className = "row";
	
	//Initialize cardId (selected card) as null
	var cardId = null;

	//When game starts
	socket.on('startGame',function(){
		// Create and draw 8 cards
		for ( var i = 1; i <= 8 ; i++){
			var div = document.createElement('div');
			div.className = "col-sm-12 col-md-12 col-lg-12 btn btn-default";
			div.id = i;
			canvas.appendChild(div);
			div.setAttribute("onclick", "selected(this.id)");
			//div.style.borderRadius = "25px";
			//div.style.border = "2px solid #73AD21";
			drawAnswer(i);
		}
		
		// "You are the Card Czar"
		var div = document.createElement('div');
		div.className = "col-sm-12 col-md-12 col-lg-12";
		div.innerHTML = "<h2> You are the Card Czar <h2>";
		div.style.display = "none";
		div.id = "cardCzar";
		canvas.appendChild(div);
		
		// Played Cards
		div = document.createElement('div');
		div.id = "playedCards";
		document.getElementById("cardCzar").appendChild(div);
		
		
		// Create div that sticks to bottom of canvas
		div = document.createElement('div');
		div.id = "bottom";
		div.style.position = "absolute";
		div.style.bottom = 0;
		div.style.width = "100%";
		canvas.appendChild(div);
		
		// Create a "confirm selection" button
		div = document.createElement('div');
		div.className = "col-sm-12 col-md-12 col-lg-12 btn btn-default";
		div.innerHTML = "Confirm selection";
		document.getElementById("bottom").appendChild(div);
		div.setAttribute("onclick", "playCard()");
		
		//Create a div for question (black card)
		div = document.createElement('div');
		div.id = "question";
		div.className = "col-sm-6 col-md-6 col-lg-6";
		div.style.borderRadius = "25px";
		div.style.border = "2px solid #fff";
		div.style.paddingLeft = "5%";
		div.style.backgroundColor = "#333";
		div.style.float = "right"
		div.style.color = "#fff";
		document.getElementById("bottom").appendChild(div);
		
		//Create a div for scoreboard
		div = document.createElement('div');
		div.id = "scores";
		div.className = "col-sm-6 col-md-6 col-lg-6";
		div.style.borderRadius = "25px";
		div.style.border = "2px solid #fff";
		div.style.paddingLeft = "5%";
		div.style.backgroundColor = "#333";
		div.style.float = "left"
		div.style.color = "#fff";
		document.getElementById("bottom").appendChild(div);
	})

	// Select a card
	function selected(id){
		clear(cardId);
		document.getElementById(id).className = "col-sm-12 col-md-12 col-lg-12 btn btn-default active";
		cardId = id;
	}	

	// Deselect a card
	function clear(id){
		if (cardId!=null){
			document.getElementById(id).className = "col-sm-12 col-md-12 col-lg-12 btn btn-default";
			cardId = null;
		}
	}

	// Play a card
	function playCard(){	
		if (cardId == null) return;
		var string = document.getElementById(cardId).innerHTML;
		socket.emit('playedCard', string);
		drawAnswer(cardId);
		for (var i = 1; i <= 8; i++){ // Disable all cards
			document.getElementById(i).className = "col-sm-12 col-md-12 col-lg-12 btn btn-default disabled";
		}
	}
	
	// New turn
	socket.on('newTurn', function(){
		for (var i = 1; i <= 8; i++){ //Reenable all cards
			document.getElementById(i).className = "col-sm-12 col-md-12 col-lg-12 btn btn-default";
		}
	});
	
	socket.on('newQuestion', function(data){
		// Update question for everybody
		document.getElementById("question").innerHTML= "<h4>" + data + "</h4>";
	});
	
	// New card Czar
	socket.on('cardCzar', function(){
		for (var i = 1; i <= 8; i++)
			document.getElementById(i).style.display = "none";
		document.getElementById("cardCzar").style.display = "inline-block";
	});
	
	// Request a new card for id
	function drawAnswer(id){
		socket.emit('drawAnswer', id);
		clear(cardId);
	}
	
	// When server returns an answer card 
	socket.on('answerCard', function(data){
		document.getElementById(data.cardId).innerHTML = data.str;
	});
	
		var first = true
	// Judging time
	socket.on('judge', function (data){
		var strings = data.split(/<>/);
		if (first){
			first = false;
			for (var j = 0; strings[j*2]!=null; j++){
				var div = document.createElement('div');
				div.id = parseInt(j + 20);
				document.getElementById("cardCzar").appendChild(div);
				div.className = "col-sm-12 col-md-12 col-lg-12 btn btn-default";
				div.innerHTML = strings[j*2];
				div.setAttribute("onclick", "czarSelected(parseInt(strings[j*2+1])");
			}
		} else {
			for (var j = 0; strings[j*2]!=null; j++){
				document.getElementById(parseInt(j + 20)).innerHTML = strings[j*2];
				document.getElementById(parseInt(j + 20)).setAttribute("onclick", "czarSelected({ str : strings[j*2] , winner: parseInt(strings[j*2+1])");				
			}
		}
	});
	
	function czarSelected (data){
		socket.emit('czarSelected', data);
	}
	
	
	// When server updates scoreboard
	socket.on('updateScores', function(data){
		var temp = document.getElementById('scores');
		if (temp != null)
			temp.innerHTML = data;
		// Set Height of Scoreboard and Question Card
		var setHeight = (document.getElementById("scores").offsetHeight > document.getElementById("question").offsetHeight ?
		document.getElementById("scores").offsetHeight : document.getElementById("question").offsetHeight);
		document.getElementById("question").style.height = setHeight;
		document.getElementById("scores").style.height = setHeight;	
	});
	
	// When hosting
	socket.on('hosting', function(){
		var players = new List();
		var currplayer = null;
		// Read in and shuffle answer cards
		var answers = answerText.split(/<>/);
		for (var i = 0; i < answers.length; i++){
			var j = Math.floor(Math.random()*answers.length);
			var temp = answers[i];
			answers[i] = answers[j];
			answers[j] = temp;
		}
		
		// Read in and shuffle question cards
		var questions = questionText.split(/<>/);
		for (var i = 0; i < questions.length; i++){
			var j = Math.floor(Math.random()*questions.length);
			var temp = questions[i];
			questions[i] = questions[j];
			questions[j] = temp;
		}
		
		var answerCount = 0;
		var questionCount = 0;
		
		// If server requests answer card
		socket.on('requestAnswer', function(data){
			var temp = answers[answerCount++];
			var data = {cardId: data.cardId, socket: data.socket, str: temp};
			socket.emit('hostAnswer', data);
		});
		
		// When a user plays a card
		socket.on('played', function(data){
			players.cardPlayed(data);
			if(players.allPlayed()){
				players.reset;	
				socket.emit('judge', {str: players.getAnswer(), socket: players.cardCzar});
			}
		});
		
		// When the card czar has judged
		socket.on('judged', function(){
			newTurn();
		});
		
		// New turn
		function newTurn(){
			// Initialize player the first time
			if (currplayer == null)
				currplayer = players.head;
			// If we can go to next player do so
			else if (players.next!=null)
				currplayer = players.next;	
			// Otherwise go back to start of list
			else 
				currplayer = players.head;	
			// Keep track of card czar
			players.cardCzar = currplayer.playerId;
			var temp = questions[questionCount++];
			var data = {socket: currplayer.playerId, str: temp};
			socket.emit('cardCzar', data);
			socket.emit('newTurn');
		}
		
		// Add "start" button for game
		var div = document.createElement('div');
		div.className = "col-sm-12 col-md-12 col-lg-12 btn btn-default";
		div.id = "startButton";
		canvas.appendChild(div);
		div.setAttribute("onclick", "socket.emit('startGame')");
		div.innerHTML = "Click here to start the game!!"
		
		socket.on('startGame', function(){
			document.getElementById("startButton").style.display = "none";
			newTurn();
		});
		
		socket.on('addPlayer', function(socket){
			players.add(socket);
		});
		
		socket.on('minPlayersNotMet', function (data){
			alert("Error not enough players. You have: " + data.numPlayers + ". You need: " + data.playersNeeded + "!");
		});
		
		//###########################################
		//#		Linked List Functions				#
		//###########################################
		// Adapted from code online https://code.tutsplus.com/articles/data-structures-with-javascript-singly-linked-list-and-doubly-linked-list--cms-23392

		function Node(playerId)
		{
			this.playerId = playerId;
			this.played = false;
			this.answer = "";
			this.next = null;
		}
			
		function List()
		{
			this._length = 0;
			this.head = null;
			this.cardCzar = null;
		}
			
		List.prototype.add = function (playerId)
		{
			var node = new Node(playerId),
				currentNode = this.head;
			
			// Empty list
			if (!currentNode)
			{
				this.head = node;
				this._length++;
				return node;
			}
			
			while (currentNode.next)
			{
				currentNode = currentNode.next;
			}
			
			currentNode.next = node;
			this._length++;
			return node;
		}
		List.prototype.cardPlayed = function (data)
		{
			currentNode = this.head;
			while (currentNode != null){
				if (currentNode.playerId == data.playerId){
					currentNode.played = true;
					currentNode.answer = data.str;
					return;
				}	
				currentNode = currentNode.next;
			}
		}
		List.prototype.reset = function()
		{
			currentNode = this.head;
			while (currentNode != null){
				currentNode.played = false;
				currentNode = currentNode.next;
			}
		}
		
		List.prototype.allPlayed = function()
		{
			currentNode = this.head;
			while (currentNode != null){
				if (currentNode.played == false)
					if (currentNode.playerId != this.cardCzar)
						return false;
				currentNode = currentNode.next;	
			}
			return true;
		}
		List.prototype.getAnswer = function()
		{
			currentNode = this.head;
			var string = "";
			while (currentNode!= null){
				if (currentNode.playerId != this.cardCzar){
					string += currentNode.answer + "<>" + currentNode.playerId + "<>";
				}
				currentNode = currentNode.next;	
			}
			return string
		}
	});
	
	
	
	//----------------------------------------
	// 			Set Width / Height
	// ---------------------------------------
	
	// Set WIDTH/HEIGHT
	// px value (e.g. '800') or percentage (e.g. '80%')
	var WIDTH = '90%';
	var HEIGHT = '500';
	
	setWidthHeight(WIDTH, HEIGHT);
	
	// Set elements to respond upon resizing of window if WIDTH / HEIGHT is a percentage
	if (isNaN(WIDTH) || isNaN(HEIGHT)){
		window.addEventListener('resize', function(){
			setWidthHeight(WIDTH, HEIGHT);
		});
	}
	
	function setWidthHeight(WIDTH, HEIGHT){
		//Convert Percentages if necessary
		if (isNaN(WIDTH))
			WIDTH = WIDTH.substring(0, WIDTH.indexOf("%")) * window.innerWidth / 100;
		if (isNaN(HEIGHT))
			HEIGHT = HEIGHT.substring(0, HEIGHT.indexOf("%")) * window.innerHeight /100;
		
		// Set body padding to center game on screen
		 document.getElementsByTagName("BODY")[0].style.paddingLeft = (window.innerWidth - WIDTH)/2;
		if (window.innerHeight > (HEIGHT * 1.5 + 20))
			document.getElementsByTagName("BODY")[0].style.paddingTop = (window.innerHeight - (HEIGHT * 1.5 + 20)) / 2;

		// Set Width and Height of all Elements on the game page
		document.getElementById('ctx').style.width = WIDTH;
		document.getElementById('ctx').style.height = HEIGHT;
		document.getElementById('chat-text').style.width = WIDTH;
		document.getElementById('chat-group').style.width = WIDTH;
		document.getElementById('chat-input').style.width = WIDTH;
		document.getElementById('chat').style.marginTop = parseInt(HEIGHT) + 20;
		document.getElementById('chat-form').style.width= WIDTH;
		document.getElementById('chat-text').style.height = parseInt(HEIGHT)/5;
		document.getElementById('chat-group').style.height = parseInt(HEIGHT)/5;
		
	}
	
	//----------------------------------------
	// 				Username Selection
	// ---------------------------------------
	var gameSelect = document.getElementById('gameSelect');
	var signDiv = document.getElementById('signDiv');
	var signDivUsername = document.getElementById('signDiv-username');
	var signDivSignIn = document.getElementById('signDiv-signIn');
	
	signDivSignIn.onclick = function(){
		signDivUsername.value = signDivUsername.value.replace(/\s/g,'');
		signDivUsername.value = filterText(signDivUsername.value);
		if (signDivUsername.value.length > 2){
			socket.emit('signIn',signDivUsername.value);
		}
		else
			alert("Please enter a username with at 3 least characters");
	}
	
	socket.on('signInResponse',function(data){
		if(data.success){
			signDiv.style.display = 'none';
			gameSelect.style.display = 'inline-block';
			showPublicGames();
			setInterval(showPublicGames, 1000);
			//Automatically select text input area
			document.getElementById('gameSelect-game').focus();
			document.getElementById('gameSelect-game').select();
		} else
			alert("Username taken");
	});
	
	// Automatically Select Text Input Area
	signDivUsername.focus();
	signDivUsername.select();
	
	// Submit when enter is pressed
	signDiv.addEventListener("keydown", function(event) {
		if (event.keyCode == 13) {
			signDivSignIn.click();
		}
	});
	
	//----------------------------------------
	// 				Game Selection
	// ---------------------------------------
	var gameDiv = document.getElementById('gameDiv');
	var gameSelect = document.getElementById('gameSelect');
	var gameSelectGame = document.getElementById('gameSelect-game');
	var gameSelectCreate = document.getElementById('gameSelect-create');
	var gameSelectJoin = document.getElementById('gameSelect-join');
	var gameSelectPassword = document.getElementById('gameSelect-password');
	
	gameSelectCreate.onclick = function(){
		gameSelectGame.value = gameSelectGame.value.replace(/\s/g,'');
		gameSelectGame.value = filterText(gameSelectGame.value);
		gameSelectPassword.value = filterText(gameSelectPassword.value);
		if (gameSelectGame.value.length > 3){
			socket.emit('createGame',gameSelectGame.value, gameSelectPassword.value);
		}
		else
			alert("Please enter a game name with at 4 least characters");
	}
	
	showPublicGames = function() {
		socket.emit('gameSelection');
	}
	
	socket.on('publicGames', function (gameList){
		document.getElementById('gameList').innerHTML = "<div>" + gameList + "</div>";
	});
	
	socket.on('createGameResponse',function(data){
		if(data.success){
			gameSelect.style.display = 'none';
			gameDiv.style.display = 'inline-block';
			if (!data.chat)
				document.getElementById('chat').style.display = 'none';
			if(!data.universal)
				document.getElementById('chats').style.display = 'none';
			if(data.controls)
				trackControls(data.wasd);
			clearInterval(showPublicGames);
		} else
			alert("Game name taken");
	});	
	
	gameSelectJoin.onclick = function(){
		gameSelectGame.value = gameSelectGame.value.replace(/\s/g,'');
		gameSelectGame.value = filterText(gameSelectGame.value);
		if (gameSelectGame.value.length > 3){
			socket.emit('joinGame',gameSelectGame.value, gameSelectPassword.value);
		}
		else
			alert("Please enter a game name with at 4 least characters");
	}
	
	socket.on('joinGameResponse',function(data){
		if(data.success){
			clearInterval(showPublicGames);
			gameSelect.style.display = 'none';
			gameDiv.style.display = 'inline-block';
			if (!data.chat)
				document.getElementById('chat').style.display = 'none';
			if(!data.universal)
				document.getElementById('chats').style.display = 'none';
			if(data.controls)
				trackControls(data.wasd);
				
		} else {
			if (data.gameExist)
				alert("Incorrect password");
			else if (data.gameFull)
				alert("Game is full");
			else if (data.started)
				alert("Game is in progress")
			else
				alert("Game doesn't exist");
		}
	});	
	
	//----------------------------------------
	// 				Chat
	// ---------------------------------------
	var chatDiv = document.getElementById('chat');
	var chatText = document.getElementById('chat-text');
	var chatInput = document.getElementById('chat-input');
	var chatForm = document.getElementById('chat-form');
	var groupChat = document.getElementById('chat-group');
	var chats = document.getElementById('chats');
	
	socket.on('addToChat',function(data){
		chatText.innerHTML += '<div>' + data + '</div>';
		chatText.scrollTop = chatText.scrollHeight;
	});
	
	socket.on('addToGame', function(data){
		groupChat.innerHTML += '<div>' + data + '</div>';
		groupChat.scrollTop = groupChat.scrollHeight;
	});
	
	displayChat = function(){
		if (chats.value==="universal"){
			chatText.style.display = 'inline-block';
			groupChat.style.display = 'none';
		}else {
			chatText.style.display = 'none';
			groupChat.style.display = 'inline-block';
		}
	}
		
	chatForm.onsubmit = function(e){
		e.preventDefault();
		chatInput.value = filterText(chatInput.value);
		if (chatInput.value.length > 0){
			if (chats.value==="universal")
				socket.emit('sendMsgToServer',chatInput.value);
			else
				socket.emit('sendMsgToGame', chatInput.value);
			chatInput.value = '';		
		}
	}
	
	//----------------------------------------
	//			Code Injection Security
	// ---------------------------------------
	
	filterText = function(text){
		// Remove everything except accepted characters
		text = text.replace(/[^ a-zA-Z0-9.,!?:;()áéíóúÁÉÍÓÚ]/g, "");
		// Remove multiple spaces
		text = text.replace(/[ ]+/g, " ");
		return text;
	}
	
	/*
	
	//----------------------------------------
	// 				Controls
	// ---------------------------------------
	trackControls = function(wasd){
		if (wasd){ // Take WASD as up, left, down and right respectively, gameCanvas must be selected
			var gameCanvas = document.getElementById('game');
			gameCanvas.onkeydown = function(event){
				if(event.keyCode === 68)	// D
					socket.emit('keyPress',{inputId:'right',state:true});
				else if(event.keyCode === 83)	// S
					socket.emit('keyPress',{inputId:'down',state:true});
				else if(event.keyCode === 65) //A
					socket.emit('keyPress',{inputId:'left',state:true});
				else if(event.keyCode === 87) // W
					socket.emit('keyPress',{inputId:'up',state:true});		
			}
			
			gameCanvas.onkeyup = function(event){
					if(event.keyCode === 68)	// D
					socket.emit('keyPress',{inputId:'right',state:false});
				else if(event.keyCode === 83)	// S
					socket.emit('keyPress',{inputId:'down',state:false});
				else if(event.keyCode === 65) //A
					socket.emit('keyPress',{inputId:'left',state:false});
				else if(event.keyCode === 87) // W
					socket.emit('keyPress',{inputId:'up',state:false});	
			}
		}
		document.onkeydown = function(event){
			if(event.keyCode === 39)	// right
				socket.emit('keyPress',{inputId:'right',state:true});
			else if(event.keyCode === 40)	// down
				socket.emit('keyPress',{inputId:'down',state:true});
			else if(event.keyCode === 37) // left
				socket.emit('keyPress',{inputId:'left',state:true});
			else if(event.keyCode === 38) // up
				socket.emit('keyPress',{inputId:'up',state:true});	
		}
		
		document.onkeyup = function(event){
			if(event.keyCode === 39)	// right
				socket.emit('keyPress',{inputId:'right',state:false});
			else if(event.keyCode === 40)	// down
				socket.emit('keyPress',{inputId:'down',state:false});
			else if(event.keyCode === 37) // left
				socket.emit('keyPress',{inputId:'left',state:false});
			else if(event.keyCode === 38) // up
				socket.emit('keyPress',{inputId:'up',state:false});
		}
	}
	*/
</script>

<!-- Source files for Question and Answer text -->
<script  src="/client/answers.txt"></script>
<script  src="/client/questions.txt"></script>

<!-- Bootstrap CDN -->
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


